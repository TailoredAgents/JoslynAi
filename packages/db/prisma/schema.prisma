generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Minimal schema for Phase 1 vertical slice

model Children {
  id        String   @id @default(uuid()) @db.Uuid
  org_id    String?  @db.Uuid
  name      String
  school_name String?
  dob       DateTime?
  created_at DateTime @default(now())

  @@map("children")
}

model Documents {
  id          String   @id @default(uuid()) @db.Uuid
  child_id    String   @db.Uuid
  type        String
  storage_uri String
  sha256      String
  doc_tags    Json
  original_name String?
  version     Int      @default(1)
  processed_at DateTime?
  created_at  DateTime @default(now())

  @@map("documents")
}

model DocSpan {
  id           String   @id @default(uuid()) @db.Uuid
  document_id  String   @db.Uuid
  page         Int
  bbox         Float[]  @db.DoublePrecision
  page_width   Float?   @db.DoublePrecision
  page_height  Float?   @db.DoublePrecision
  text         String
  created_at   DateTime @default(now())

  @@map("doc_spans")
}

model IepExtract {
  id                   String   @id @default(uuid()) @db.Uuid
  document_id          String   @unique @db.Uuid
  services_json        Json
  goals_json           Json
  accommodations_json  Json
  placement            String?
  start_date           DateTime?
  end_date             DateTime?
  notes                String?
  created_at           DateTime @default(now())

  @@map("iep_extract")
}

// Phase 2 additions

model timeline_rules {
  id            String   @id @default(uuid()) @db.Uuid
  jurisdiction  String
  kind          String
  delta_days    Int
  description   String?
  source_url    String?
  active        Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@index([jurisdiction, kind])
  @@unique([jurisdiction, kind])
}

model deadlines {
  id            String   @id @default(uuid()) @db.Uuid
  child_id      String
  kind          String
  base_date     DateTime
  due_date      DateTime
  jurisdiction  String
  source_doc_id String?
  created_at    DateTime @default(now())
}

model letters {
  id          String   @id @default(uuid()) @db.Uuid
  child_id    String
  kind        String
  status      String   @default("draft")
  draft_json  Json
  pdf_uri     String?
  sent_via    String?
  sent_at     DateTime?
  created_at  DateTime @default(now())
}

model claims {
  id                   String   @id @default(uuid()) @db.Uuid
  child_id             String
  service_date         DateTime?
  provider             String?
  amounts_json         Json?
  status               String   @default("open")
  linked_document_ids  Json?
  created_at           DateTime @default(now())
}

model eobs {
  id             String   @id @default(uuid()) @db.Uuid
  claim_id       String
  document_id    String
  parsed_json    Json?
  explanation_text String?
  created_at     DateTime @default(now())

  @@unique([document_id])
}

model next_best_steps {
  id            String   @id @default(uuid()) @db.Uuid
  org_id        String?
  child_id      String
  kind          String
  payload_json  Json
  dedupe_key    String?
  suggested_at  DateTime @default(now())
  expires_at    DateTime?
  accepted_at   DateTime?
  dismissed_at  DateTime?

  @@unique([child_id, kind, dedupe_key])
}

model notifications {
  id            String   @id @default(uuid()) @db.Uuid
  org_id        String?
  user_id       String?
  kind          String
  payload_json  Json
  send_at       DateTime
  sent_at       DateTime?
  channel       String   @default("email")
  created_at    DateTime @default(now())
}

model agent_runs {
  id            String   @id @default(uuid()) @db.Uuid
  org_id        String?
  user_id       String?
  child_id      String?
  intent        String
  inputs_json   Json
  outputs_json  Json
  tokens        Int      @default(0)
  cost_cents    Int      @default(0)
  route         String?
  created_at    DateTime @default(now())
}

model entitlements {
  id            String   @id @default(uuid()) @db.Uuid
  org_id        String   @unique
  plan          String
  features_json Json
  created_at    DateTime @default(now())
}

model glossaries {
  id         String   @id @default(uuid()) @db.Uuid
  org_id     String
  terms_json Json
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([org_id])
}

model share_links {
  id            String   @id @default(uuid()) @db.Uuid
  org_id        String
  resource_type String
  resource_id   String
  token         String   @unique
  expires_at    DateTime?
  created_at    DateTime @default(now())
}

model child_profile {
  id          String   @id @default(uuid()) @db.Uuid
  child_id    String
  profile_json Json
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
}

model events {
  id           String   @id @default(uuid()) @db.Uuid
  org_id       String?
  user_id      String?
  type         String
  payload_json Json
  created_at   DateTime @default(now())
}

model org_settings {
  id          String   @id @default(uuid()) @db.Uuid
  org_id      String   @unique
  retain_days Int      @default(365)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
}

model orgs {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  created_at  DateTime @default(now())
}

model org_members {
  id        String   @id @default(uuid()) @db.Uuid
  org_id    String
  user_id   String
  role      String
  created_at DateTime @default(now())

  @@index([org_id, user_id])
}

model invites {
  id        String   @id @default(uuid()) @db.Uuid
  org_id    String
  email     String
  role      String
  token     String   @unique
  accepted_at DateTime?
  created_at DateTime @default(now())
}

model users {
  id         String   @id @default(uuid()) @db.Uuid
  email      String   @unique
  name       String?
  created_at DateTime @default(now())
}

model job_runs {
  id           String   @id @default(uuid()) @db.Uuid
  child_id     String
  type         String
  status       String
  error_text   String?
  payload_json Json?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@index([child_id, created_at])
}
